---

- hosts: all
  remote_user: admin
  become: yes

  tasks:

    - name: Install zsh, powerline, and libffi from repo
      pacman:
        update_cache: yes
        name:
          - which
          - zsh
          - python-pip
          - powerline
          - libffi # for some reason this doesn't get installed

    - name: Run command to install libffi
      shell: "yes | pacman -Sy libffi"

    - name: Create .zshrc file for admin
      file:
        path: /home/admin/.zshrc
        state: touch
        mode: u=rw,g=r,o=r
        modification_time: preserve
        access_time: preserve

    - name: Create .zshrc file for root
      file:
        path: /root/.zshrc
        state: touch
        mode: u=rw,g=r,o=r
        modification_time: preserve
        access_time: preserve
      become_user: root

    - name: Get powerline repository path
      shell: "pip show powerline-status | grep Location: | grep -o '/[^\"]*'"
      register: powerline_path

    - name: Add powerline configuration into .zshrc files
      blockinfile:
        dest: /home/admin/.zshrc
        block: |
          powerline-daemon -q
          . {{ powerline_path.stdout }}/powerline/bindings/zsh/powerline.zsh

    - name: Add powerline configuration into .zshrc files
      blockinfile:
        dest: /root/.zshrc
        block: |
          powerline-daemon -q
          . {{ powerline_path.stdout }}/powerline/bindings/zsh/powerline.zsh

    - name: Get zsh path
      shell: "which zsh"
      register: zsh_path

    - name: Make zsh the default shell for the admin user
      user:
        name: admin
        shell: "{{ zsh_path.stdout }}"

    - name: Make zsh the default shell for root
      user:
        name: root
        shell: "{{ zsh_path.stdout }}"